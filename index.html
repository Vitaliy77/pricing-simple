<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Pricing App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="p-8 bg-gray-100">
  <h1 class="text-2xl font-bold mb-4">Construction Pricing Calculator</h1>
<div class="bg-white p-6 rounded shadow-md mb-4">
  <h2 class="text-xl font-bold mb-4">Job Details</h2>
  <label class="block mb-2">Job ID:</label>
  <input id="jobId" type="text" class="border p-2 w-full mb-4" placeholder="e.g., JOB-100">
  
  <label class="block mb-2">Activity Code:</label>
  <select id="activityCode" class="border p-2 w-full mb-4" onchange="loadDefaults()">
    <option value="">Select Activity</option>
  </select>
  
  <label class="block mb-2">Quantity:</label>
  <input id="quantity" type="number" step="0.01" class="border p-2 w-full mb-4" placeholder="e.g., 225" onchange="calculateCost()">
  
  <h2 class="text-xl font-bold mb-4">Labor</h2>
  <label class="block mb-2">Role 1:</label>
  <select id="laborRole1" class="border p-2 w-full mb-2" onchange="loadLaborRate('1')">
    <option value="">Select Role</option>
  </select>
  <label class="block mb-2">Hours per Unit (Role 1):</label>
  <input id="laborHrs1" type="number" step="0.01" class="border p-2 w-full mb-2" placeholder="e.g., 0.2" onchange="calculateCost()">
  <p id="laborRate1" class="text-sm text-gray-600 mb-4">Loaded Rate: $0.00</p>
  
  <h2 class="text-xl font-bold mb-4">Equipment</h2>
  <label class="block mb-2">Equipment 1:</label>
  <select id="equipType1" class="border p-2 w-full mb-2" onchange="loadEquipRate('1')">
    <option value="">Select Equipment</option>
  </select>
  <label class="block mb-2">Hours per Unit (Equipment 1):</label>
  <input id="equipHrs1" type="number" step="0.01" class="border p-2 w-full mb-4" placeholder="e.g., 0.2" onchange="calculateCost()">
  <p id="equipRate1" class="text-sm text-gray-600 mb-4">Rate: $0.00</p>
  
  <h2 class="text-xl font-bold mb-4">Materials</h2>
  <label class="block mb-2">Material SKU:</label>
  <select id="matSku" class="border p-2 w-full mb-2" onchange="loadMatRate()">
    <option value="">Select Material</option>
  </select>
  <label class="block mb-2">Quantity per Unit:</label>
  <input id="matQty" type="number" step="0.01" class="border p-2 w-full mb-4" placeholder="e.g., 1" onchange="calculateCost()">
  <p id="matRate" class="text-sm text-gray-600 mb-4">Unit Cost: $0.00 (incl. waste)</p>
  
  <button onclick="calculateCost()" class="bg-blue-500 text-white p-2 rounded">Calculate</button>
</div>
  <div id="results" class="bg-white p-6 rounded shadow-md hidden">
    <h2 class="text-xl font-bold mb-2">Cost Breakdown</h2>
    <p id="totalDirect"></p>
    <p id="totalIndirect"></p>
    <p id="totalPrice"></p>
    <p id="variance"></p>
  </div>

<script>
  console.log('Script started');

  const supabaseUrl = 'https://yonpinjixytqooqyyzdh.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvbnBpbmppeHl0cW9vcXl5emRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjkwMzIsImV4cCI6MjA3NDk0NTAzMn0.8g9iNl4kmIm77u7TT8cylgcV872D45pzZGHJWBnZBGo';
  
  const client = supabase.createClient(supabaseUrl, supabaseKey);
  console.log('Supabase client created');

  // Load activities dropdown
  async function loadActivities() {
    try {
      console.log('Loading activities...');
      const { data: activities, error } = await client.from('activities_catalog').select('activity_code, activity_name');
      if (error) throw error;
      console.log('Activities loaded:', activities);
      const select = document.getElementById('activityCode');
      activities.forEach(activity => {
        const option = document.createElement('option');
        option.value = activity.activity_code;
        option.text = `${activity.activity_code} - ${activity.activity_name}`;
        select.add(option);
      });
    } catch (error) {
      console.error('Error loading activities:', error);
      alert('Failed to load activities: ' + error.message);
    }
  }

  // Load labor roles dropdown
  async function loadLaborRoles() {
    try {
      console.log('Loading labor roles...');
      const { data: roles, error } = await client.from('labor_roles').select('role');
      if (error) throw error;
      console.log('Labor roles loaded:', roles);
      const select1 = document.getElementById('laborRole1');
      roles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.role;
        option.text = role.role;
        select1.add(option);
      });
    } catch (error) {
      console.error('Error loading labor roles:', error);
      alert('Failed to load labor roles: ' + error.message);
    }
  }

  // Load equipment dropdown
  async function loadEquipTypes() {
    try {
      console.log('Loading equipment...');
      const { data: equip, error } = await client.from('equipment').select('equip_type');
      if (error) throw error;
      console.log('Equipment loaded:', equip);
      const select1 = document.getElementById('equipType1');
      equip.forEach(e => {
        const option = document.createElement('option');
        option.value = e.equip_type;
        option.text = e.equip_type;
        select1.add(option);
      });
    } catch (error) {
      console.error('Error loading equipment:', error);
      alert('Failed to load equipment: ' + error.message);
    }
  }

  // Load materials dropdown
  async function loadMatTypes() {
    try {
      console.log('Loading materials...');
      const { data: mat, error } = await client.from('materials').select('sku, description');
      if (error) throw error;
      console.log('Materials loaded:', mat);
      const select = document.getElementById('matSku');
      mat.forEach(m => {
        const option = document.createElement('option');
        option.value = m.sku;
        option.text = `${m.sku} - ${m.description}`;
        select.add(option);
      });
    } catch (error) {
      console.error('Error loading materials:', error);
      alert('Failed to load materials: ' + error.message);
    }
  }

  // Load defaults when activity changes
  async function loadDefaults() {
    const activityCode = document.getElementById('activityCode').value;
    if (!activityCode) return;
    
    try {
      const { data: activity } = await client.from('activities_catalog').select('*').eq('activity_code', activityCode).single();
      if (activity) {
        // Load labor defaults
        document.getElementById('laborRole1').value = activity.default_role1 || '';
        await loadLaborRate('1');
        document.getElementById('laborHrs1').value = activity.default_role1_hrs_per_unit || 0;
        
        // Load equipment defaults
        document.getElementById('equipType1').value = activity.default_equip1 || '';
        await loadEquipRate('1');
        document.getElementById('equipHrs1').value = activity.default_equip1_hrs_per_unit || 0;
        
        // Load material defaults
        document.getElementById('matSku').value = activity.default_mat1_sku || '';
        await loadMatRate();
        document.getElementById('matQty').value = activity.default_mat1_qty_per_unit || 0;
      }
    } catch (error) {
      console.error('Error loading defaults:', error);
    }
  }

  // Load labor rate
  async function loadLaborRate(num) {
    const role = document.getElementById('laborRole1').value;
    if (!role) return;
    try {
      const { data: labor } = await client.from('labor_roles').select('base_rate, burden_pct').eq('role', role).single();
      const loadedRate = (labor.base_rate * (1 + labor.burden_pct)).toFixed(2);
      document.getElementById('laborRate1').innerHTML = `Loaded Rate: $${loadedRate}`;
    } catch (error) {
      console.error('Error loading labor rate:', error);
    }
  }

  // Load equipment rate
  async function loadEquipRate(num) {
    const equipType = document.getElementById('equipType1').value;
    if (!equipType) return;
    try {
      const { data: equip } = await client.from('equipment').select('rate').eq('equip_type', equipType).single();
      document.getElementById('equipRate1').innerHTML = `Rate: $${equip.rate.toFixed(2)}`;
    } catch (error) {
      console.error('Error loading equipment rate:', error);
    }
  }

  // Load material rate
  async function loadMatRate() {
    const sku = document.getElementById('matSku').value;
    if (!sku) return;
    try {
      const { data: mat } = await client.from('materials').select('unit_cost, waste_pct').eq('sku', sku).single();
      const costWithWaste = mat.unit_cost * (1 + mat.waste_pct);
      document.getElementById('matRate').innerHTML = `Unit Cost: $${costWithWaste.toFixed(2)} (incl. waste)`;
    } catch (error) {
      console.error('Error loading material rate:', error);
    }
  }

// Calculate cost with benchmarks
async function calculateCost() {
  const jobId = document.getElementById('jobId').value;
  const activityCode = document.getElementById('activityCode').value;
  const quantity = parseFloat(document.getElementById('quantity').value) || 0;
  const laborHrs1 = parseFloat(document.getElementById('laborHrs1').value) || 0;
  const equipHrs1 = parseFloat(document.getElementById('equipHrs1').value) || 0;
  const matQty = parseFloat(document.getElementById('matQty').value) || 0;

  if (!activityCode || quantity === 0) {
    alert('Please select an activity and enter quantity');
    return;
  }

  try {
    // Fetch rates
    const { data: labor } = await client.from('labor_roles').select('base_rate, burden_pct').eq('role', document.getElementById('laborRole1').value).single();
    const { data: equip } = await client.from('equipment').select('rate').eq('equip_type', document.getElementById('equipType1').value).single();
    const { data: mat } = await client.from('materials').select('unit_cost, waste_pct').eq('sku', document.getElementById('matSku').value).single();

    // Calculate costs
    const laborCost = (labor.base_rate * (1 + labor.burden_pct)) * laborHrs1 * quantity;
    const equipCost = equip.rate * equipHrs1 * quantity;
    const matCost = mat.unit_cost * matQty * quantity * (1 + mat.waste_pct);
    const totalDirect = laborCost + equipCost + matCost;

    // Fetch config
    const { data: gna } = await client.from('config').select('value').eq('parameter', 'G&A_%_of_Direct').single();
    const { data: profit } = await client.from('config').select('value').eq('parameter', 'Default_Profit_Margin_%').single();
    const { data: alertThreshold } = await client.from('config').select('value').eq('parameter', 'Benchmark_Variance_Alert_%').single();
    const totalIndirect = totalDirect * gna.value;
    const totalPrice = (totalDirect + totalIndirect) * (1 + profit.value);

    // Fetch benchmarks (medians from history for this activity)
    const { data: benchmarks } = await client
      .from('history')
      .select('labor_hours_per_unit, equip_hours_per_unit, mat_qty_per_unit')
      .eq('activity_code', activityCode);

    // Calculate medians (simple average for demo; use SQL median in production)
    const medianLaborHrs = benchmarks.length > 0 ? benchmarks.reduce((a, b) => a + b.labor_hours_per_unit, 0) / benchmarks.length : laborHrs1;
    const medianEquipHrs = benchmarks.length > 0 ? benchmarks.reduce((a, b) => a + b.equip_hours_per_unit, 0) / benchmarks.length : equipHrs1;
    const medianMatQty = benchmarks.length > 0 ? benchmarks.reduce((a, b) => a + b.mat_qty_per_unit, 0) / benchmarks.length : matQty;

    // Calculate variances
    const laborVariance = ((laborHrs1 - medianLaborHrs) / medianLaborHrs * 100).toFixed(1);
    const equipVariance = ((equipHrs1 - medianEquipHrs) / medianEquipHrs * 100).toFixed(1);
    const matVariance = ((matQty - medianMatQty) / medianMatQty * 100).toFixed(1);

    // Alert class
    function getAlertClass(variance) {
      const absVar = Math.abs(variance);
      if (absVar < 10) return 'text-green-600';
      if (absVar < 15) return 'text-yellow-600';
      return 'text-red-600';
    }

    // Show results
    document.getElementById('totalDirect').innerHTML = `Total Direct Cost: $${totalDirect.toFixed(2)}`;
    document.getElementById('totalIndirect').innerHTML = `Total Indirect Cost: $${totalIndirect.toFixed(2)}`;
    document.getElementById('totalPrice').innerHTML = `Total Price: $${totalPrice.toFixed(2)}`;

    // Add variance section
    document.getElementById('variance').innerHTML = `
      <h3 class="text-lg font-bold mb-2">Benchmark Comparison</h3>
      <p class="${getAlertClass(laborVariance)}">Labor Variance: ${laborVariance}% (vs median ${medianLaborHrs.toFixed(2)} hrs/unit)</p>
      <p class="${getAlertClass(equipVariance)}">Equipment Variance: ${equipVariance}% (vs median ${medianEquipHrs.toFixed(2)} hrs/unit)</p>
      <p class="${getAlertClass(matVariance)}">Material Variance: ${matVariance}% (vs median ${medianMatQty.toFixed(2)} qty/unit)</p>
    `;
    document.getElementById('results').classList.remove('hidden');
  } catch (error) {
    console.error('Error calculating cost:', error);
    alert('Calculation error: ' + error.message);
  }
}

  // Call load functions on page load
  window.onload = async () => {
    console.log('Window loaded, starting loads...');
    await loadActivities();
    await loadLaborRoles();
    await loadEquipTypes();
    await loadMatTypes();
  };
</script>
</body>
</html>

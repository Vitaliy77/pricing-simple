<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construction Pricing App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="p-8 bg-gray-100">
  <h1 class="text-2xl font-bold mb-4">Construction Pricing Calculator</h1>
<div class="bg-white p-6 rounded shadow-md mb-4">
  <h2 class="text-xl font-bold mb-4">Job Details</h2>
  <label class="block mb-2">Job ID:</label>
  <input id="jobId" type="text" class="border p-2 w-full mb-4" placeholder="e.g., JOB-100">
  
  <label class="block mb-2">Activity Code:</label>
  <select id="activityCode" class="border p-2 w-full mb-4" onchange="loadDefaults()">
    <option value="">Select Activity</option>
  </select>
  
  <label class="block mb-2">Quantity:</label>
  <input id="quantity" type="number" step="0.01" class="border p-2 w-full mb-4" placeholder="e.g., 225" onchange="calculateCost()">
  
  <h2 class="text-xl font-bold mb-4">Labor</h2>
  <label class="block mb-2">Role 1:</label>
  <select id="laborRole1" class="border p-2 w-full mb-2" onchange="loadLaborRate('1')">
    <option value="">Select Role</option>
  </select>
  <label class="block mb-2">Hours per Unit (Role 1):</label>
  <input id="laborHrs1" type="number" step="0.01" class="border p-2 w-full mb-2" placeholder="e.g., 0.2" onchange="calculateCost()">
  <p id="laborRate1" class="text-sm text-gray-600 mb-4">Loaded Rate: $0.00</p>
  
  <h2 class="text-xl font-bold mb-4">Equipment</h2>
  <label class="block mb-2">Equipment 1:</label>
  <select id="equipType1" class="border p-2 w-full mb-2" onchange="loadEquipRate('1')">
    <option value="">Select Equipment</option>
  </select>
  <label class="block mb-2">Hours per Unit (Equipment 1):</label>
  <input id="equipHrs1" type="number" step="0.01" class="border p-2 w-full mb-4" placeholder="e.g., 0.2" onchange="calculateCost()">
  <p id="equipRate1" class="text-sm text-gray-600 mb-4">Rate: $0.00</p>
  
  <h2 class="text-xl font-bold mb-4">Materials</h2>
  <label class="block mb-2">Material SKU:</label>
  <select id="matSku" class="border p-2 w-full mb-2" onchange="loadMatRate()">
    <option value="">Select Material</option>
  </select>
  <label class="block mb-2">Quantity per Unit:</label>
  <input id="matQty" type="number" step="0.01" class="border p-2 w-full mb-4" placeholder="e.g., 1" onchange="calculateCost()">
  <p id="matRate" class="text-sm text-gray-600 mb-4">Unit Cost: $0.00 (incl. waste)</p>
  
  <button onclick="calculateCost()" class="bg-blue-500 text-white p-2 rounded">Calculate</button>
</div>
  <div id="results" class="bg-white p-6 rounded shadow-md hidden">
    <h2 class="text-xl font-bold mb-2">Cost Breakdown</h2>
    <p id="totalDirect"></p>
    <p id="totalIndirect"></p>
    <p id="totalPrice"></p>
    <p id="variance"></p>
  </div>

<script>
  console.log('Script started'); // Debug 1: Script loads

  const supabaseUrl = 'https://yonpinjixytqooqyyzdh.supabase.co'; // Replace with your Supabase URL
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvbnBpbmppeHl0cW9vcXl5emRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjkwMzIsImV4cCI6MjA3NDk0NTAzMn0.8g9iNl4kmIm77u7TT8cylgcV872D45pzZGHJWBnZBGo'; // Replace with your Supabase anon key
  console.log('Supabase URL:', supabaseUrl); // Debug 2: URL set
  console.log('Supabase Key:', supabaseKey.substring(0,10) + '...'); // Debug 3: Key set (partial for security)

  const client = supabase.createClient(supabaseUrl, supabaseKey);
  console.log('Supabase client created:', client); // Debug 4: Client created

  // Load labor roles dropdown
  async function loadLaborRoles() {
    try {
      console.log('Loading labor roles...'); // Debug 5
      const { data: roles, error } = await client.from('labor_roles').select('role');
      if (error) throw error;
      console.log('Labor roles loaded:', roles); // Debug 6
      const select1 = document.getElementById('laborRole1');
      roles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.role;
        option.text = role.role;
        select1.add(option);
      });
    } catch (error) {
      console.error('Error loading labor roles:', error);
      alert('Failed to load labor roles: ' + error.message);
    }
  }

  // Load equipment dropdown
  async function loadEquipTypes() {
    try {
      console.log('Loading equipment...'); // Debug 7
      const { data: equip, error } = await client.from('equipment').select('equip_type');
      if (error) throw error;
      console.log('Equipment loaded:', equip); // Debug 8
      const select1 = document.getElementById('equipType1');
      equip.forEach(e => {
        const option = document.createElement('option');
        option.value = e.equip_type;
        option.text = e.equip_type;
        select1.add(option);
      });
    } catch (error) {
      console.error('Error loading equipment:', error);
      alert('Failed to load equipment: ' + error.message);
    }
  }

  // Load materials dropdown
  async function loadMatTypes() {
    try {
      console.log('Loading materials...'); // Debug 9
      const { data: mat, error } = await client.from('materials').select('sku, description');
      if (error) throw error;
      console.log('Materials loaded:', mat); // Debug 10
      const select = document.getElementById('matSku');
      mat.forEach(m => {
        const option = document.createElement('option');
        option.value = m.sku;
        option.text = `${m.sku} - ${m.description}`;
        select.add(option);
      });
    } catch (error) {
      console.error('Error loading materials:', error);
      alert('Failed to load materials: ' + error.message);
    }
  }

  // Call load functions on page load
  window.onload = async () => {
    console.log('Window loaded, starting loads...'); // Debug 11
    await loadLaborRoles();
    await loadEquipTypes();
    await loadMatTypes();
  };
</script>
</body>
</html>

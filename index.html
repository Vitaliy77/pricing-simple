<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Construction Pricing App</title>

  <!-- Tailwind (CDN – fine for now) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto p-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">Construction Pricing Calculator</h1>
      <div class="text-xs text-gray-500">Supabase • GitHub • DigitalOcean</div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left: Inputs -->
    <section class="lg:col-span-2 space-y-6">
      <!-- Job & Activity -->
      <div class="bg-white p-5 rounded-xl shadow-sm space-y-4">
        <h2 class="text-lg font-semibold">Job & Activity</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Job ID</label>
            <input id="jobId" type="text" class="border rounded-md p-2 w-full" placeholder="e.g., JOB-100">
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Activity Code</label>
            <select id="activityCode" class="border rounded-md p-2 w-full" onchange="loadDefaults()">
              <option value="">Select Activity</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Quantity</label>
            <input id="quantity" type="number" step="0.01" class="border rounded-md p-2 w-full" placeholder="e.g., 225" onchange="calculateCost()">
          </div>
        </div>
      </div>

      <!-- Labor (multi-row) -->
      <div class="bg-white p-5 rounded-xl shadow-sm space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Labor</h2>
          <button type="button" class="text-sm px-3 py-1 rounded-md bg-gray-100 hover:bg-gray-200"
                  onclick="addLaborRow()">+ Add Labor</button>
        </div>

        <div id="laborRows" class="space-y-3">
          <!-- Rows injected here -->
        </div>
      </div>

      <!-- Equipment (multi-row) -->
      <div class="bg-white p-5 rounded-xl shadow-sm space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Equipment</h2>
          <button type="button" class="text-sm px-3 py-1 rounded-md bg-gray-100 hover:bg-gray-200"
                  onclick="addEquipRow()">+ Add Equipment</button>
        </div>

        <div id="equipRows" class="space-y-3">
          <!-- Rows injected here -->
        </div>
      </div>

      <!-- Materials (multi-row) -->
      <div class="bg-white p-5 rounded-xl shadow-sm space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Materials</h2>
          <button type="button" class="text-sm px-3 py-1 rounded-md bg-gray-100 hover:bg-gray-200"
                  onclick="addMatRow()">+ Add Material</button>
        </div>

        <div id="matRows" class="space-y-3">
          <!-- Rows injected here -->
        </div>

        <div class="flex items-center gap-3 pt-2">
          <button onclick="calculateCost()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
            Calculate
          </button>
          <span id="saveStatus" class="text-sm text-green-600 hidden"></span>
        </div>
      </div>
    </section>

    <!-- Right: Results -->
    <aside class="lg:col-span-1">
      <div class="sticky top-6 space-y-6">
        <div class="bg-white p-5 rounded-xl shadow-sm">
          <h2 class="text-lg font-semibold mb-3">Cost Breakdown</h2>
          <dl class="space-y-2">
            <div class="flex items-center justify-between">
              <dt class="text-sm text-gray-600">Total Direct</dt>
              <dd id="totalDirect" class="font-medium">$0.00</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt class="text-sm text-gray-600">Total Indirect</dt>
              <dd id="totalIndirect" class="font-medium">$0.00</dd>
            </div>
            <div class="flex items-center justify-between border-t pt-2">
              <dt class="text-sm text-gray-800">Total Price</dt>
              <dd id="totalPrice" class="text-lg font-semibold">$0.00</dd>
            </div>
          </dl>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm">
          <h3 class="text-lg font-semibold mb-2">Benchmark Comparison</h3>
          <div id="variance" class="text-sm text-gray-700">
            <p class="text-gray-500">Run a calculation to see benchmark variances.</p>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <!-- ===== App Code ===== -->
  <script>
    // Supabase client
    const supabaseUrl = 'https://yonpinjixytqooqyyzdh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvbnBpbmppeHl0cW9vcXl5emRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjkwMzIsImV4cCI6MjA3NDk0NTAzMn0.8g9iNl4kmIm77u7TT8cylgcV872D45pzZGHJWBnZBGo';
    const client = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Simple caches so we fetch lists once
    let _roles = null, _equipTypes = null, _materials = null;

    // ---------- Fetch list helpers ----------
    async function fetchRoles() {
      if (_roles) return _roles;
      const { data, error } = await client.from('labor_roles').select('role').order('role');
      if (error) throw error;
      _roles = data?.map(r => r.role) || [];
      return _roles;
    }
    async function fetchEquipTypes() {
      if (_equipTypes) return _equipTypes;
      const { data, error } = await client.from('equipment').select('type').order('type');
      if (error) throw error;
      _equipTypes = data?.map(e => e.type) || [];
      return _equipTypes;
    }
    async function fetchMaterials() {
      if (_materials) return _materials;
      const { data, error } = await client.from('materials').select('sku, description').order('sku');
      if (error) throw error;
      _materials = data || [];
      return _materials;
    }

    // Populate activities (unchanged)
    async function loadActivities() {
      try {
        const { data, error } = await client
          .from('activities_catalog')
          .select('activity_code, activity_name')
          .order('activity_code');
        if (error) throw error;
        const select = document.getElementById('activityCode');
        select.innerHTML = '<option value="">Select Activity</option>';
        data.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.activity_code;
          opt.text = `${a.activity_code} - ${a.activity_name}`;
          select.add(opt);
        });
      } catch (err) {
        console.error('loadActivities:', err);
        alert('Failed to load activities: ' + (err?.message ?? err));
      }
    }

    // ---------- Row creators ----------
    function removeRow(btn) {
      const row = btn.closest('.row');
      if (row) row.remove();
      calculateCost();
    }

    async function addLaborRow(prefill = {}) {
      const wrap = document.getElementById('laborRows');
      const row = document.createElement('div');
      row.className = 'row labor-row grid grid-cols-1 md:grid-cols-5 gap-3 items-center';
      row.innerHTML = `
        <div class="md:col-span-2">
          <select class="labor-role border rounded-md p-2 w-full"><option value="">Select Role</option></select>
        </div>
        <div>
          <input class="labor-hpu border rounded-md p-2 w-full" type="number" step="0.01" placeholder="Hours/unit">
        </div>
        <div class="text-sm text-gray-600 labor-rate">Rate: $0.00</div>
        <div class="text-right">
          <button type="button" class="text-sm text-red-600" onclick="removeRow(this)">Remove</button>
        </div>
      `;
      wrap.appendChild(row);

      // Fill select
      const sel = row.querySelector('.labor-role');
      const hpu = row.querySelector('.labor-hpu');
      const rateEl = row.querySelector('.labor-rate');
      const roles = await fetchRoles();
      sel.innerHTML = '<option value="">Select Role</option>' + roles.map(r => `<option>${r}</option>`).join('');
      if (prefill.role) sel.value = prefill.role;
      if (prefill.hpu != null) hpu.value = prefill.hpu;

      // Listeners
      sel.addEventListener('change', async () => { await updateLaborRateForRow(row); calculateCost(); });
      hpu.addEventListener('input', calculateCost);

      // Initial rate load if prefilled
      if (sel.value) await updateLaborRateForRow(row);
      return row;
    }

    async function addEquipRow(prefill = {}) {
      const wrap = document.getElementById('equipRows');
      const row = document.createElement('div');
      row.className = 'row equip-row grid grid-cols-1 md:grid-cols-5 gap-3 items-center';
      row.innerHTML = `
        <div class="md:col-span-2">
          <select class="equip-type border rounded-md p-2 w-full"><option value="">Select Equipment</option></select>
        </div>
        <div>
          <input class="equip-hpu border rounded-md p-2 w-full" type="number" step="0.01" placeholder="Hours/unit">
        </div>
        <div class="text-sm text-gray-600 equip-rate">Rate: $0.00</div>
        <div class="text-right">
          <button type="button" class="text-sm text-red-600" onclick="removeRow(this)">Remove</button>
        </div>
      `;
      wrap.appendChild(row);

      const sel = row.querySelector('.equip-type');
      const hpu = row.querySelector('.equip-hpu');
      const types = await fetchEquipTypes();
      sel.innerHTML = '<option value="">Select Equipment</option>' + types.map(t => `<option>${t}</option>`).join('');
      if (prefill.type) sel.value = prefill.type;
      if (prefill.hpu != null) hpu.value = prefill.hpu;

      sel.addEventListener('change', async () => { await updateEquipRateForRow(row); calculateCost(); });
      hpu.addEventListener('input', calculateCost);

      if (sel.value) await updateEquipRateForRow(row);
      return row;
    }

    async function addMatRow(prefill = {}) {
      const wrap = document.getElementById('matRows');
      const row = document.createElement('div');
      row.className = 'row mat-row grid grid-cols-1 md:grid-cols-5 gap-3 items-center';
      row.innerHTML = `
        <div class="md:col-span-2">
          <select class="mat-sku border rounded-md p-2 w-full"><option value="">Select Material</option></select>
        </div>
        <div>
          <input class="mat-qpu border rounded-md p-2 w-full" type="number" step="0.01" placeholder="Qty/unit">
        </div>
        <div class="text-sm text-gray-600 mat-rate">Unit: $0.00</div>
        <div class="text-right">
          <button type="button" class="text-sm text-red-600" onclick="removeRow(this)">Remove</button>
        </div>
      `;
      wrap.appendChild(row);

      const sel = row.querySelector('.mat-sku');
      const qpu = row.querySelector('.mat-qpu');
      const mats = await fetchMaterials();
      sel.innerHTML = '<option value="">Select Material</option>' + mats.map(m => `<option value="${m.sku}">${m.sku} - ${m.description}</option>`).join('');
      if (prefill.sku) sel.value = prefill.sku;
      if (prefill.qpu != null) qpu.value = prefill.qpu;

      sel.addEventListener('change', async () => { await updateMatRateForRow(row); calculateCost(); });
      qpu.addEventListener('input', calculateCost);

      if (sel.value) await updateMatRateForRow(row);
      return row;
    }

    // ---------- Per-row rate updaters ----------
    async function updateLaborRateForRow(row) {
      const sel = row.querySelector('.labor-role');
      const rateEl = row.querySelector('.labor-rate');
      const role = sel.value;
      let loaded = 0;
      if (role) {
        const { data, error } = await client.from('labor_roles').select('base_rate, burden_pct').eq('role', role).maybeSingle();
        if (!error && data) loaded = Number(data.base_rate) * (1 + Number(data.burden_pct));
      }
      rateEl.textContent = `Rate: $${loaded.toFixed(2)}`;
      sel.dataset.loadedRate = String(loaded);
    }

    async function updateEquipRateForRow(row) {
      const sel = row.querySelector('.equip-type');
      const rateEl = row.querySelector('.equip-rate');
      const type = sel.value;
      let rate = 0;
      if (type) {
        const { data, error } = await client.from('equipment').select('rate').eq('type', type).maybeSingle();
        if (!error && data) rate = Number(data.rate);
      }
      rateEl.textContent = `Rate: $${rate.toFixed(2)}`;
      sel.dataset.rate = String(rate);
    }

    async function updateMatRateForRow(row) {
      const sel = row.querySelector('.mat-sku');
      const rateEl = row.querySelector('.mat-rate');
      const sku = sel.value;
      let unit = 0, waste = 0;
      if (sku) {
        const { data, error } = await client.from('materials').select('unit_cost, waste_pct').eq('sku', sku).maybeSingle();
        if (!error && data) { unit = Number(data.unit_cost); waste = Number(data.waste_pct); }
      }
      const unitWithWaste = unit * (1 + waste);
      rateEl.textContent = `Unit: $${unitWithWaste.toFixed(2)}`;
      sel.dataset.unitWithWaste = String(unitWithWaste);
    }

    // ---------- Defaults (fill the first row of each group) ----------
    async function loadDefaults() {
      const activityCode = document.getElementById('activityCode').value;
      if (!activityCode) return;
      try {
        const { data: a, error } = await client
          .from('activities_catalog')
          .select('*')
          .eq('activity_code', activityCode)
          .maybeSingle();
        if (error) throw error;
        if (!a) return;

        // Ensure at least one row exists in each section
        if (!document.querySelector('.labor-row')) await addLaborRow();
        if (!document.querySelector('.equip-row')) await addEquipRow();
        if (!document.querySelector('.mat-row'))   await addMatRow();

        // Labor default into first row
        const lrow = document.querySelector('.labor-row');
        const lsel = lrow.querySelector('.labor-role');
        const lhpu = lrow.querySelector('.labor-hpu');
        lsel.value = a.default_role1 || '';
        lhpu.value = a.default_role1_hrs_per_unit || 0;
        await updateLaborRateForRow(lrow);

        // Equipment default into first row
        const erow = document.querySelector('.equip-row');
        const esel = erow.querySelector('.equip-type');
        const ehpu = erow.querySelector('.equip-hpu');
        esel.value = a.default_equip1 || '';
        ehpu.value = a.default_equip1_hrs_per_unit || 0;
        await updateEquipRateForRow(erow);

        // Materials default into first row
        const mrow = document.querySelector('.mat-row');
        const msel = mrow.querySelector('.mat-sku');
        const mqpu = mrow.querySelector('.mat-qpu');
        msel.value = a.default_mat1_sku || '';
        mqpu.value = a.default_mat1_qty_per_unit || 0;
        await updateMatRateForRow(mrow);

        calculateCost();
      } catch (err) {
        console.error('loadDefaults:', err);
      }
    }

    // ---------- Calculate (sum over all rows) ----------
    async function calculateCost() {
      const quantity = parseFloat(document.getElementById('quantity').value) || 0;
      if (!quantity) {
        document.getElementById('totalDirect').innerText = '$0.00';
        document.getElementById('totalIndirect').innerText = '$0.00';
        document.getElementById('totalPrice').innerText = '$0.00';
        return;
      }

      try {
        // Labor
        let laborCost = 0;
        document.querySelectorAll('.labor-row').forEach(row => {
          const sel = row.querySelector('.labor-role');
          const hpu = parseFloat(row.querySelector('.labor-hpu').value) || 0;
          const rate = parseFloat(sel.dataset.loadedRate || '0');
          laborCost += rate * hpu * quantity;
        });

        // Equipment
        let equipCost = 0;
        document.querySelectorAll('.equip-row').forEach(row => {
          const sel = row.querySelector('.equip-type');
          const hpu = parseFloat(row.querySelector('.equip-hpu').value) || 0;
          const rate = parseFloat(sel.dataset.rate || '0');
          equipCost += rate * hpu * quantity;
        });

        // Materials
        let matCost = 0;
        document.querySelectorAll('.mat-row').forEach(row => {
          const sel = row.querySelector('.mat-sku');
          const qpu = parseFloat(row.querySelector('.mat-qpu').value) || 0;
          const unit = parseFloat(sel.dataset.unitWithWaste || '0');
          matCost += unit * qpu * quantity;
        });

        const totalDirect = laborCost + equipCost + matCost;

        // Indirects & profit
        const { data: gna }    = await client.from('config').select('value').eq('parameter','G&A_%_of_Direct').maybeSingle();
        const { data: profit } = await client.from('config').select('value').eq('parameter','Default_Profit_Margin_%').maybeSingle();
        const gnaPct    = Number(gna?.value ?? 0);
        const profitPct = Number(profit?.value ?? 0);
        const totalIndirect = totalDirect * gnaPct;
        const totalPrice    = (totalDirect + totalIndirect) * (1 + profitPct);

        // Render totals
        document.getElementById('totalDirect').innerText   = `$${totalDirect.toFixed(2)}`;
        document.getElementById('totalIndirect').innerText = `$${totalIndirect.toFixed(2)}`;
        document.getElementById('totalPrice').innerText    = `$${totalPrice.toFixed(2)}`;

        // Benchmarks (still simple averages from history for now)
        const activityCode = document.getElementById('activityCode').value;
        let medianLaborHrs = 0, medianEquipHrs = 0, medianMatQty = 0;
        if (activityCode) {
          const { data: benchmarks } = await client
            .from('history')
            .select('labor_hours_per_unit, equip_hours_per_unit, mat_qty_per_unit')
            .eq('activity_code', activityCode);
          const avg = (arr, k) => (arr && arr.length) ? arr.reduce((s,x)=> s + Number(x[k] ?? 0), 0) / arr.length : 0;
          medianLaborHrs = avg(benchmarks, 'labor_hours_per_unit');
          medianEquipHrs = avg(benchmarks, 'equip_hours_per_unit');
          medianMatQty   = avg(benchmarks, 'mat_qty_per_unit');
        }

        // Current totals for per-unit (sum of HPU/QPU across rows)
        const sumHPU = (sel, cls) => Array.from(document.querySelectorAll(sel))
            .reduce((s, r) => s + (parseFloat(r.querySelector(cls).value) || 0), 0);
        const currLaborHrs = sumHPU('.labor-row', '.labor-hpu');
        const currEquipHrs = sumHPU('.equip-row', '.equip-hpu');
        const currMatQty   = sumHPU('.mat-row',   '.mat-qpu');

        const laborVar = medianLaborHrs ? ((currLaborHrs - medianLaborHrs)/medianLaborHrs*100) : 0;
        const equipVar = medianEquipHrs ? ((currEquipHrs - medianEquipHrs)/medianEquipHrs*100) : 0;
        const matVar   = medianMatQty   ? ((currMatQty   - medianMatQty)  /medianMatQty*100)   : 0;

        const alertClass = (v) => {
          const a = Math.abs(v);
          if (a < 10) return 'text-green-600';
          if (a < 15) return 'text-yellow-600';
          return 'text-red-600';
        };

        document.getElementById('variance').innerHTML = `
          <p class="${alertClass(laborVar)}">Labor Variance: ${laborVar.toFixed(1)}% (vs ${medianLaborHrs.toFixed(2)} hrs/unit)</p>
          <p class="${alertClass(equipVar)}">Equipment Variance: ${equipVar.toFixed(1)}% (vs ${medianEquipHrs.toFixed(2)} hrs/unit)</p>
          <p class="${alertClass(matVar)}">Material Variance: ${matVar.toFixed(1)}% (vs ${medianMatQty.toFixed(2)} qty/unit)</p>
        `;

        // Save snapshot (non-blocking)
        await saveEstimateSnapshot({ totalDirect, totalIndirect, totalPrice });
      } catch (err) {
        console.error('calculateCost:', err);
        alert('Calculation error: ' + (err?.message ?? err));
      }
    }

    // ---------- Save Snapshot (multi-line) ----------
    async function saveEstimateSnapshot({ totalDirect, totalIndirect, totalPrice }) {
      try {
        let sessionKey = localStorage.getItem('pricing_session_key');
        if (!sessionKey) {
          sessionKey = (crypto?.randomUUID?.() || String(Date.now()));
          localStorage.setItem('pricing_session_key', sessionKey);
        }

        const { data: est } = await client
          .from('estimates')
          .upsert({ session_key: sessionKey, project_name: 'Ad-hoc' }, { onConflict: 'session_key' })
          .select('id')
          .maybeSingle();
        if (!est?.id) return;

        const activity_code = document.getElementById('activityCode').value;
        const quantity      = Number(document.getElementById('quantity').value || 0);

        const { data: item } = await client
          .from('estimate_items')
          .insert({
            estimate_id: est.id,
            activity_code,
            quantity,
            direct_cost: totalDirect,
            indirect_cost: totalIndirect,
            total_price: totalPrice
          })
          .select('id')
          .single();

        // Labor children
        for (const row of document.querySelectorAll('.labor-row')) {
          const role = row.querySelector('.labor-role').value;
          const hpu  = Number(row.querySelector('.labor-hpu').value || 0);
          const rate = Number(row.querySelector('.labor-role').dataset.loadedRate || 0);
          if (role && hpu) {
            await client.from('estimate_item_labor').upsert({
              estimate_item_id: item.id,
              role,
              hours_per_unit: hpu,
              loaded_rate_snapshot: rate
            });
          }
        }

        // Equipment children
        for (const row of document.querySelectorAll('.equip-row')) {
          const type = row.querySelector('.equip-type').value;
          const hpu  = Number(row.querySelector('.equip-hpu').value || 0);
          const rate = Number(row.querySelector('.equip-type').dataset.rate || 0);
          if (type && hpu) {
            await client.from('estimate_item_equipment').upsert({
              estimate_item_id: item.id,
              equipment_type: type,
              hours_per_unit: hpu,
              rate_snapshot: rate
            });
          }
        }

        // Material children
        for (const row of document.querySelectorAll('.mat-row')) {
          const sku  = row.querySelector('.mat-sku').value;
          const qpu  = Number(row.querySelector('.mat-qpu').value || 0);
          const unit = Number(row.querySelector('.mat-sku').dataset.unitWithWaste || 0);
          if (sku && qpu) {
            await client.from('estimate_item_materials').upsert({
              estimate_item_id: item.id,
              sku,
              qty_per_unit: qpu,
              unit_cost_snapshot: unit,   /* includes waste */
              waste_pct_snapshot: null
            });
          }
        }

        // Success toast
        const el = document.getElementById('saveStatus');
        if (el) {
          el.textContent = `Saved at ${new Date().toLocaleTimeString()}`;
          el.classList.remove('hidden', 'text-red-600');
          el.classList.add('text-green-600');
          setTimeout(() => el.classList.add('hidden'), 2500);
        }
      } catch (err) {
        console.error('saveEstimateSnapshot:', err);
        const el = document.getElementById('saveStatus');
        if (el) {
          el.textContent = `Save failed: ${err?.message ?? err}`;
          el.classList.remove('hidden', 'text-green-600');
          el.classList.add('text-red-600');
        }
      }
    }

    // ---------- Init ----------
    async function initLists() {
      console.log('initLists: add default rows & populate dropdowns…');

      // Add one blank row per section first (so selects exist)
      await addLaborRow();
      await addEquipRow();
      await addMatRow();

      // Populate activities
      await loadActivities();

      const el = document.getElementById('saveStatus');
      if (el) { el.textContent = 'Lists loaded'; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'), 2000); }
    }
    document.addEventListener('DOMContentLoaded', initLists);

    // Expose only what the markup calls directly
    Object.assign(window, { loadDefaults, calculateCost, addLaborRow, addEquipRow, addMatRow, removeRow });
  </script>
</body>
</html>

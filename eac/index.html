<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EAC Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">EAC Dashboard</h1>
      <nav class="text-sm text-gray-500 space-x-4">
        <a href="/" class="hover:text-gray-700">Pricing Tool</a>
        <span class="text-gray-300">|</span>
        <span class="text-gray-700 font-medium">EAC</span>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- Project picker + model -->
    <section class="bg-white rounded-xl shadow-sm p-5">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 mb-1">Project</label>
          <div class="flex gap-2">
            <select id="projectSelect" class="border rounded-md p-2 w-full"></select>
            <button id="refreshBtn" class="px-3 py-2 bg-gray-100 border rounded-md hover:bg-gray-200">Refresh</button>
          </div>
          <p id="projectMeta" class="text-xs text-gray-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">Revenue Model</label>
          <span id="revModelBadge" class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-blue-50 text-blue-700">—</span>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-8 gap-4">
      <div class="bg-white rounded-xl shadow-sm p-4"><div class="text-xs text-gray-500">BAC</div><div id="kpiBAC" class="text-lg font-semibold">$0</div></div>
      <div class="bg-white rounded-xl shadow-sm p-4"><div class="text-xs text-gray-500">AC (to date)</div><div id="kpiAC" class="text-lg font-semibold">$0</div></div>
      <div class="bg-white rounded-xl shadow-sm p-4"><div class="text-xs text-gray-500">EV</div><div id="kpiEV" class="text-lg font-semibold">$0</div></div>
      <div class="bg-white rounded-xl shadow-sm p-4"><div class="text-xs text-gray-500">CPI</div><div id="kpiCPI" class="text-lg font-semibold">—</div></div>
      <div class="bg-white rounded-xl shadow-sm p-4"><div class="text-xs text-gray-500">ETC (CPI)</div><div id="kpiETC" class="text-lg font-semibold">$0</div></div>
      <div class="bg-white rounded-xl shadow-sm p-4"><div class="text-xs text-gray-500">EAC</div><div id="kpiEAC" class="text-lg font-semibold">$0</div></div>
      <div class="bg-white rounded-xl shadow-sm p-4"><div class="text-xs text-gray-500">VAC</div><div id="kpiVAC" class="text-lg font-semibold">$0</div></div>
      <div class="bg-white rounded-xl shadow-sm p-4"><div class="text-xs text-gray-500">% Complete (EV/BAC)</div><div id="kpiPct" class="text-lg font-semibold">0%</div></div>
    </section>

    <!-- Data Entry (Actuals & Progress) -->
    <section class="bg-white rounded-xl shadow-sm p-5">
      <details open>
        <summary class="cursor-pointer text-lg font-semibold">Data Entry (Actuals & Progress)</summary>
        <p class="text-xs text-gray-500 mt-1">Add rows directly to Supabase. These forms are minimal by design—enter the amounts you want recognized this month.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5 mt-4">
          <!-- Progress -->
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Progress (Qty Complete)</h3>
            <label class="block text-xs text-gray-600">Date</label>
            <input id="prgDate" type="date" class="border rounded p-2 w-full mb-2">
            <label class="block text-xs text-gray-600">Activity</label>
            <select id="prgActivity" class="border rounded p-2 w-full mb-2"></select>
            <label class="block text-xs text-gray-600">Qty Completed</label>
            <input id="prgQty" type="number" step="0.01" class="border rounded p-2 w-full mb-3">
            <button id="btnAddProgress" class="bg-emerald-600 text-white px-3 py-2 rounded hover:bg-emerald-700">Add Progress</button>
            <div id="prgMsg" class="text-xs mt-2"></div>
          </div>

          <!-- Labor Actuals -->
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Labor Actuals</h3>
            <label class="block text-xs text-gray-600">Date</label>
            <input id="labDate" type="date" class="border rounded p-2 w-full mb-2">
            <label class="block text-xs text-gray-600">Activity</label>
            <select id="labActivity" class="border rounded p-2 w-full mb-2"></select>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-600">Hours</label>
                <input id="labHours" type="number" step="0.01" class="border rounded p-2 w-full mb-2">
              </div>
              <div>
                <label class="block text-xs text-gray-600">Cost (snapshot)</label>
                <input id="labCost" type="number" step="0.01" class="border rounded p-2 w-full mb-2" placeholder="e.g., 480">
              </div>
            </div>
            <button id="btnAddLabor" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">Add Labor</button>
            <div id="labMsg" class="text-xs mt-2"></div>
          </div>

          <!-- Equipment Actuals -->
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Equipment Actuals</h3>
            <label class="block text-xs text-gray-600">Date</label>
            <input id="eqDate" type="date" class="border rounded p-2 w-full mb-2">
            <label class="block text-xs text-gray-600">Activity</label>
            <select id="eqActivity" class="border rounded p-2 w-full mb-2"></select>
            <label class="block text-xs text-gray-600">Equipment</label>
            <select id="eqType" class="border rounded p-2 w-full mb-2"></select>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-600">Hours</label>
                <input id="eqHours" type="number" step="0.01" class="border rounded p-2 w-full mb-2">
              </div>
              <div>
                <label class="block text-xs text-gray-600">Cost (snapshot)</label>
                <input id="eqCost" type="number" step="0.01" class="border rounded p-2 w-full mb-2">
              </div>
            </div>
            <button id="btnAddEquip" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">Add Equipment</button>
            <div id="eqMsg" class="text-xs mt-2"></div>
          </div>

          <!-- Materials Actuals -->
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Materials Actuals</h3>
            <label class="block text-xs text-gray-600">Date</label>
            <input id="matDate" type="date" class="border rounded p-2 w-full mb-2">
            <label class="block text-xs text-gray-600">Activity</label>
            <select id="matActivity" class="border rounded p-2 w-full mb-2"></select>
            <label class="block text-xs text-gray-600">Material</label>
            <select id="matSku" class="border rounded p-2 w-full mb-2"></select>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-600">Qty</label>
                <input id="matQty" type="number" step="0.01" class="border rounded p-2 w-full mb-2">
              </div>
              <div>
                <label class="block text-xs text-gray-600">Cost (snapshot)</label>
                <input id="matCost" type="number" step="0.01" class="border rounded p-2 w-full mb-2">
              </div>
            </div>
            <button id="btnAddMat" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">Add Material</button>
            <div id="matMsg" class="text-xs mt-2"></div>
          </div>

          <!-- Subcontractor Actuals -->
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Subcontractor Actuals</h3>
            <label class="block text-xs text-gray-600">Date</label>
            <input id="subDate" type="date" class="border rounded p-2 w-full mb-2">
            <label class="block text-xs text-gray-600">Activity</label>
            <select id="subActivity" class="border rounded p-2 w-full mb-2"></select>
            <label class="block text-xs text-gray-600">Cost</label>
            <input id="subCost" type="number" step="0.01" class="border rounded p-2 w-full mb-3">
            <button id="btnAddSub" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">Add Sub Cost</button>
            <div id="subMsg" class="text-xs mt-2"></div>
          </div>
        </div>
      </details>
    </section>

    <!-- Monthly P&L (pivot: months = columns, line items = rows) -->
    <section class="bg-white rounded-xl shadow-sm p-5">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Monthly P&amp;L</h2>
        <div class="text-xs text-gray-500" id="plHint"></div>
      </div>
      <div class="overflow-x-auto mt-3">
        <table class="min-w-full text-sm">
          <thead class="text-xs text-gray-500 bg-gray-50" id="plHead"></thead>
          <tbody id="plBodyPivot" class="divide-y"></tbody>
          <tfoot class="bg-gray-50" id="plFootPivot"></tfoot>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ---- CONFIG ----
    const supabaseUrl = 'https://yonpinjixytqooqyyzdh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvbnBpbmppeHl0cW9vcXl5emRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjkwMzIsImV4cCI6MjA3NDk0NTAzMn0.8g9iNl4kmIm77u7TT8cylgcV872D45pzZGHJWBnZBGo';
    const client = window.supabase.createClient(supabaseUrl, supabaseKey);
    const DEFAULT_PROJECT_ID = 'bd5e7f00-ed56-4596-8414-62679107cae7';

    // ---- HELPERS ----
    const fmt$ = (n) => (isFinite(n) ? n : 0).toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    const monthKey = (d) => { const dt = new Date(d); return `${dt.getUTCFullYear()}-${String(dt.getUTCMonth()+1).padStart(2,'0')}-01`; };
    const monthLabel = (key) => { const [y,m] = key.split('-').map(Number); return new Date(Date.UTC(y, m-1, 1)).toLocaleString(undefined,{ month:'short', year:'numeric' }); };
    const sum = (arr, fn = (x)=>x) => arr.reduce((a,b)=>a + (fn(b)||0), 0);
    const safe = (x) => (x==null || isNaN(x)) ? 0 : Number(x);

    // ---- PROJECTS ----
    async function loadProjects() {
      const sel = document.getElementById('projectSelect');
      sel.innerHTML = '';
      const { data, error } = await client.from('projects').select('id, name, revenue_model, funding_ceiling, fee_pct').order('name');
      if (error) { console.error(error); return; }
      data.forEach(p => { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; sel.appendChild(opt); });
      sel.value = data.find(p => p.id === DEFAULT_PROJECT_ID)?.id || (data[0]?.id ?? '');
      sel.addEventListener('change', () => loadAll(sel.value));
      showProjectMeta(data.find(p => p.id === sel.value));
      return sel.value;
    }
    function showProjectMeta(p) {
      const m = document.getElementById('projectMeta');
      const badge = document.getElementById('revModelBadge');
      if (!p) { m.textContent = ''; badge.textContent='—'; return; }
      m.textContent = `Funding Ceiling: ${p.funding_ceiling ? fmt$(p.funding_ceiling) : 'n/a'} • Fee%: ${p.fee_pct ? (p.fee_pct*100).toFixed(1)+'%' : '0%'}`;
      const label = {unit:'Unit-based', tm:'Time & Materials', fixed_price:'Fixed Price', cost_plus:'Cost-Plus Fee'}[p.revenue_model] || p.revenue_model;
      badge.textContent = label;
    }
    async function getProject(projectId) {
      const { data } = await client.from('projects').select('id, name, revenue_model, funding_ceiling, fee_pct').eq('id', projectId).maybeSingle();
      return data;
    }

    // ---- BASELINE / PROGRESS / ACTUALS ----
    async function getBaseline(projectId) {
      const { data, error } = await client.from('estimate_items')
        .select('activity_code, quantity, total_price')
        .eq('project_id', projectId);
      if (error) { console.warn('baseline error', error); return []; }
      return data || [];
    }
    async function getProgress(projectId) {
      const { data, error } = await client.from('activity_progress')
        .select('dt, activity_code, qty_completed')
        .eq('project_id', projectId);
      if (error) { console.warn('progress error', error); return []; }
      return data || [];
    }
    async function getActuals(projectId) {
      const grab = async (table, cols) => {
        const { data, error } = await client.from(table).select(cols).eq('project_id', projectId);
        if (error) { console.warn(`${table} error`, error); return []; }
        return data || [];
      };
      return {
        labor:     await grab('labor_actuals',     'dt, hours, cost_snapshot'),
        equip:     await grab('equipment_actuals', 'dt, hours, cost_snapshot'),
        materials: await grab('materials_actuals', 'dt, qty, cost_snapshot'),
        subs:      await grab('sub_actuals',       'dt, cost')
      };
    }
    async function getConfig() {
      const cfg = { fringe:0.35, oh:0.10, gna:0.08, matMarkup:0, subMarkup:0 };
      const { data:ind } = await client.from('indirect_rates').select('*').limit(1).maybeSingle();
      if (ind) { cfg.fringe = safe(ind.fringe_pct); cfg.oh = safe(ind.overhead_pct); cfg.gna = safe(ind.gna_pct); }
      const { data:bm } = await client.from('billing_markups').select('*').limit(1).maybeSingle();
      if (bm) { cfg.matMarkup = safe(bm.materials_markup_pct); cfg.subMarkup = safe(bm.subs_markup_pct); }
      return cfg;
    }

    // ---- MAPS / CALCS ----
    function baselineMaps(rows) {
      const perAct = {};
      rows.forEach(r => {
        const qty = safe(r.quantity), price = safe(r.total_price);
        perAct[r.activity_code] ||= { qty:0, price:0 };
        perAct[r.activity_code].qty += qty; perAct[r.activity_code].price += price;
      });
      const unitRate = {};
      Object.entries(perAct).forEach(([act, agg]) => unitRate[act] = agg.qty > 0 ? agg.price/agg.qty : 0);
      return { perAct, unitRate, BAC: sum(Object.values(perAct), v => v.price) };
    }
    function progressByMonth(rows) {
      const byMonthAct = {}; // {month: {act: {monthQty,cumQty}}}
      const monthActRaw = {};
      rows.forEach(r => { const mk = monthKey(r.dt); monthActRaw[mk] ||= {}; monthActRaw[mk][r.activity_code] = (monthActRaw[mk][r.activity_code] || 0) + safe(r.qty_completed); });
      const months = Object.keys(monthActRaw).sort();
      const cumByAct = {};
      months.forEach(mk => {
        byMonthAct[mk] = {};
        Object.entries(monthActRaw[mk]).forEach(([act, monthQty]) => {
          cumByAct[act] = (cumByAct[act] || 0) + monthQty;
          byMonthAct[mk][act] = { monthQty, cumQty: cumByAct[act] };
        });
      });
      return { months, byMonthAct };
    }
    function actualCostsByMonth(actuals) {
      const acc = {}; // {month: {labor,equip,mat,subs}}
      const bump = (mk, k, v) => { acc[mk] ||= { labor:0,equip:0,mat:0,subs:0 }; acc[mk][k] += safe(v); };
      actuals.labor.forEach(r => bump(monthKey(r.dt),'labor', r.cost_snapshot));
      actuals.equip.forEach(r => bump(monthKey(r.dt),'equip', r.cost_snapshot));
      actuals.materials.forEach(r => bump(monthKey(r.dt),'mat', r.cost_snapshot));
      actuals.subs.forEach(r => bump(monthKey(r.dt),'subs', r.cost));
      return acc;
    }
    async function revenueByMonth(project, maps, prog, actuals, cfg) {
      const acc = {}; const model = project.revenue_model;
      if (model === 'unit') {
        prog.months.forEach(mk => {
          let rev = 0;
          const acts = prog.byMonthAct[mk] || {};
          Object.entries(acts).forEach(([act, info]) => rev += (maps.unitRate[act]||0) * info.monthQty);
          acc[mk] = rev;
        });
      } else if (model === 'tm') {
        const months = new Set();
        actuals.labor.forEach(r=>months.add(monthKey(r.dt)));
        actuals.equip.forEach(r=>months.add(monthKey(r.dt)));
        actuals.materials.forEach(r=>months.add(monthKey(r.dt)));
        actuals.subs.forEach(r=>months.add(monthKey(r.dt)));
        [...months].forEach(mk => acc[mk] = 0);
        actuals.labor.forEach(r => { const mk = monthKey(r.dt); acc[mk] += safe(r.cost_snapshot); });
        actuals.equip.forEach(r => { const mk = monthKey(r.dt); acc[mk] += safe(r.cost_snapshot); });
        actuals.materials.forEach(r => { const mk = monthKey(r.dt); acc[mk] += safe(r.cost_snapshot) * (1 + cfg.matMarkup); });
        actuals.subs.forEach(r => { const mk = monthKey(r.dt); acc[mk] += safe(r.cost) * (1 + cfg.subMarkup); });
      } else if (model === 'fixed_price') {
        const fund = safe(project.funding_ceiling); if (fund <= 0) return acc;
        const months = prog.months; let prevCumRev = 0;
        months.forEach(mk => {
          let EVcum = 0;
          const acts = prog.byMonthAct[mk] || {};
          Object.entries(acts).forEach(([act, info]) => { const b = maps.perAct[act]; if (b && b.qty>0) EVcum += b.price * (info.cumQty / b.qty); });
          const pct = (maps.BAC>0) ? (EVcum / maps.BAC) : 0;
          const cumRev = fund * Math.min(Math.max(pct, 0), 1);
          acc[mk] = cumRev - prevCumRev; prevCumRev = cumRev;
        });
      } else if (model === 'cost_plus') {
        const costs = actualCostsByMonth(actuals);
        Object.entries(costs).forEach(([mk, c]) => { const direct = safe(c.labor)+safe(c.equip)+safe(c.mat)+safe(c.subs); acc[mk] = direct * (1 + safe(project.fee_pct)); });
      }
      return acc;
    }
    function indirectsByMonth(costsMonth, cfg) {
      const out = {};
      Object.entries(costsMonth).forEach(([mk, c]) => {
        const labor = safe(c.labor), direct = labor + safe(c.equip) + safe(c.mat) + safe(c.subs);
        out[mk] = { fringe: labor*cfg.fringe, oh: direct*cfg.oh, gna: direct*cfg.gna };
      });
      return out;
    }
    function computeAC(costsMonth) {
      let t=0; Object.values(costsMonth).forEach(c=>{ t += safe(c.labor)+safe(c.equip)+safe(c.mat)+safe(c.subs); }); return t;
    }
    function computeEVtoDate(maps, prog) {
      if (!prog.months.length) return 0;
      const lastMonth = prog.months[prog.months.length-1]; const acts = prog.byMonthAct[lastMonth] || {};
      let EV=0; Object.entries(acts).forEach(([act, info]) => { const b = maps.perAct[act]; if (b && b.qty>0) EV += b.price * (info.cumQty / b.qty); });
      return EV;
    }

    // ---- RENDER: KPIs ----
    function renderKPIs({ BAC, AC, EV, CPI, ETC, EAC, VAC }) {
      document.getElementById('kpiBAC').textContent = fmt$(BAC);
      document.getElementById('kpiAC').textContent  = fmt$(AC);
      document.getElementById('kpiEV').textContent  = fmt$(EV);
      document.getElementById('kpiCPI').textContent = (CPI && isFinite(CPI)) ? CPI.toFixed(2) : '—';
      document.getElementById('kpiETC').textContent = fmt$(ETC);
      document.getElementById('kpiEAC').textContent = fmt$(EAC);
      document.getElementById('kpiVAC').textContent = fmt$(VAC);
      document.getElementById('kpiPct').textContent = (BAC>0) ? ((EV/BAC)*100).toFixed(1)+'%' : '0%';
    }

    // ---- RENDER: P&L PIVOT (months as columns) ----
    function renderPLPivot(project, revenueMonth, costsMonth, indirectsMonth) {
      const months = Array.from(new Set([...Object.keys(revenueMonth), ...Object.keys(costsMonth)])).sort();
      const head = document.getElementById('plHead');
      const body = document.getElementById('plBodyPivot');
      const foot = document.getElementById('plFootPivot');
      head.innerHTML = ''; body.innerHTML = ''; foot.innerHTML='';

      // Header
      const th = document.createElement('tr');
      th.innerHTML = `<th class="text-left px-3 py-2">Line Item</th>`
        + months.map(mk => `<th class="text-right px-3 py-2">${monthLabel(mk)}</th>`).join('')
        + `<th class="text-right px-3 py-2">Total</th>`;
      head.appendChild(th);

      // Helper to build a row
      const row = (label, getter) => {
        let total = 0;
        const tds = months.map(mk => { const v = getter(mk); total += safe(v); return `<td class="px-3 py-2 text-right">${fmt$(v)}</td>`; }).join('');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-3 py-2">${label}</td>${tds}<td class="px-3 py-2 text-right font-semibold">${fmt$(total)}</td>`;
        body.appendChild(tr);
      };

      // Build rows
      row('Revenue',   mk => safe(revenueMonth[mk]));
      row('Labor',     mk => safe((costsMonth[mk]||{}).labor));
      row('Equip',     mk => safe((costsMonth[mk]||{}).equip));
      row('Materials', mk => safe((costsMonth[mk]||{}).mat));
      row('Subs',      mk => safe((costsMonth[mk]||{}).subs));
      row('Fringe',    mk => safe((indirectsMonth[mk]||{}).fringe));
      row('Overhead',  mk => safe((indirectsMonth[mk]||{}).oh));
      row('G&A',       mk => safe((indirectsMonth[mk]||{}).gna));

      // Profit row
      const profitGetter = mk => {
        const rev = safe(revenueMonth[mk]);
        const c   = costsMonth[mk] || {labor:0,equip:0,mat:0,subs:0};
        const ind = indirectsMonth[mk] || {fringe:0,oh:0,gna:0};
        return rev - (safe(c.labor)+safe(c.equip)+safe(c.mat)+safe(c.subs)) - (ind.fringe+ind.oh+ind.gna);
      };
      row('Profit', profitGetter);

      document.getElementById('plHint').textContent =
        `Revenue model: ${({unit:'Unit-based', tm:'T&M', fixed_price:'Fixed Price', cost_plus:'Cost-Plus Fee'})[project.revenue_model] || project.revenue_model}`;
    }

    // ---- LOAD AUX LISTS for forms ----
    async function loadActivitiesInto(selectId) {
      const { data } = await client.from('activities_catalog').select('activity_code, activity_name').order('activity_code');
      const sel = document.getElementById(selectId); sel.innerHTML = '<option value="">Select…</option>';
      (data||[]).forEach(a => { const o=document.createElement('option'); o.value=a.activity_code; o.textContent=`${a.activity_code} — ${a.activity_name}`; sel.appendChild(o); });
    }
    async function loadEquipmentInto(selectId) {
      const { data } = await client.from('equipment').select('type').order('type');
      const sel = document.getElementById(selectId); sel.innerHTML = '<option value="">Select…</option>';
      (data||[]).forEach(e => { const o=document.createElement('option'); o.value=e.type; o.textContent=e.type; sel.appendChild(o); });
    }
    async function loadMaterialsInto(selectId) {
      const { data } = await client.from('materials').select('sku, description').order('sku');
      const sel = document.getElementById(selectId); sel.innerHTML = '<option value="">Select…</option>';
      (data||[]).forEach(m => { const o=document.createElement('option'); o.value=m.sku; o.textContent=`${m.sku} — ${m.description}`; sel.appendChild(o); });
    }

    // ---- SAVE HANDLERS ----
    function setMsg(el, text, ok=true) { el.textContent = text; el.className = `text-xs mt-2 ${ok?'text-emerald-700':'text-red-600'}`; }

    async function addProgress(projectId) {
      const dt = document.getElementById('prgDate').value;
      const act= document.getElementById('prgActivity').value;
      const qty= parseFloat(document.getElementById('prgQty').value||'0');
      const msg= document.getElementById('prgMsg');
      if (!dt || !act || qty<=0) return setMsg(msg, 'Please enter date, activity, and positive quantity.', false);
      const { error } = await client.from('activity_progress').insert({ dt, project_id:projectId, activity_code:act, qty_completed:qty });
      if (error) return setMsg(msg, `Error: ${error.message}`, false);
      setMsg(msg, 'Progress added.'); await loadAll(projectId);
    }
    async function addLabor(projectId) {
      const dt = document.getElementById('labDate').value;
      const act= document.getElementById('labActivity').value;
      const hrs= parseFloat(document.getElementById('labHours').value||'0');
      const cost=parseFloat(document.getElementById('labCost').value||'0');
      const msg= document.getElementById('labMsg');
      if (!dt || !act || hrs<=0 || cost<=0) return setMsg(msg, 'Please enter date, activity, hours and cost.', false);
      const { error } = await client.from('labor_actuals').insert({ dt, project_id:projectId, activity_code:act, hours:hrs, cost_snapshot:cost });
      if (error) return setMsg(msg, `Error: ${error.message}`, false);
      setMsg(msg, 'Labor actual added.'); await loadAll(projectId);
    }
    async function addEquip(projectId) {
      const dt = document.getElementById('eqDate').value;
      const act= document.getElementById('eqActivity').value;
      const type=document.getElementById('eqType').value;
      const hrs= parseFloat(document.getElementById('eqHours').value||'0');
      const cost=parseFloat(document.getElementById('eqCost').value||'0');
      const msg= document.getElementById('eqMsg');
      if (!dt || !act || !type || hrs<=0 || cost<=0) return setMsg(msg, 'Enter date, activity, equipment, hours, and cost.', false);
      const { error } = await client.from('equipment_actuals').insert({ dt, project_id:projectId, activity_code:act, equipment_type:type, hours:hrs, cost_snapshot:cost });
      if (error) return setMsg(msg, `Error: ${error.message}`, false);
      setMsg(msg, 'Equipment actual added.'); await loadAll(projectId);
    }
    async function addMat(projectId) {
      const dt = document.getElementById('matDate').value;
      const act= document.getElementById('matActivity').value;
      const sku=document.getElementById('matSku').value;
      const qty= parseFloat(document.getElementById('matQty').value||'0');
      const cost=parseFloat(document.getElementById('matCost').value||'0');
      const msg= document.getElementById('matMsg');
      if (!dt || !act || !sku || qty<=0 || cost<=0) return setMsg(msg, 'Enter date, activity, material, qty, and cost.', false);
      const { error } = await client.from('materials_actuals').insert({ dt, project_id:projectId, activity_code:act, sku, qty, cost_snapshot:cost });
      if (error) return setMsg(msg, `Error: ${error.message}`, false);
      setMsg(msg, 'Material actual added.'); await loadAll(projectId);
    }
    async function addSub(projectId) {
      const dt = document.getElementById('subDate').value;
      const act= document.getElementById('subActivity').value;
      const cost=parseFloat(document.getElementById('subCost').value||'0');
      const msg= document.getElementById('subMsg');
      if (!dt || !act || cost<=0) return setMsg(msg, 'Enter date, activity, and cost.', false);
      const { error } = await client.from('sub_actuals').insert({ dt, project_id:projectId, activity_code:act, cost });
      if (error) return setMsg(msg, `Error: ${error.message}`, false);
      setMsg(msg, 'Subcontract cost added.'); await loadAll(projectId);
    }

    // ---- MAIN LOAD ----
    async function loadAll(projectId) {
      const project = await getProject(projectId); showProjectMeta(project);

      const [baselineRows, progressRows, actuals, cfg] = await Promise.all([
        getBaseline(projectId), getProgress(projectId), getActuals(projectId), getConfig()
      ]);

      const maps = baselineMaps(baselineRows);
      const prog = progressByMonth(progressRows);
      const costsMonth = actualCostsByMonth(actuals);
      const revenueMonth = await revenueByMonth(project, maps, {months:prog.months, byMonthAct:prog.byMonthAct}, actuals, cfg);
      const indirectsMonth = indirectsByMonth(costsMonth, cfg);

      const BAC = maps.BAC;
      const AC  = computeAC(costsMonth);
      const EV  = computeEVtoDate(maps, {months:prog.months, byMonthAct:prog.byMonthAct});
      const CPI = (AC>0) ? (EV/AC) : null;
      const effCPI = (CPI==null || CPI<=0) ? 1 : Math.max(CPI, 0.70);
      const ETC = Math.max(0, BAC - EV) / effCPI;
      const EAC = AC + ETC;
      const VAC = BAC - EAC;

      renderKPIs({ BAC, AC, EV, CPI, ETC, EAC, VAC });
      renderPLPivot(project, revenueMonth, costsMonth, indirectsMonth);
    }

    // ---- INIT ----
    window.addEventListener('DOMContentLoaded', async () => {
      const firstId = await loadProjects();

      // Load dropdown options for forms
      await Promise.all([
        loadActivitiesInto('prgActivity'),
        loadActivitiesInto('labActivity'),
        loadActivitiesInto('eqActivity'),
        loadEquipmentInto('eqType'),
        loadActivitiesInto('matActivity'),
        loadMaterialsInto('matSku'),
        loadActivitiesInto('subActivity'),
      ]);

      // Buttons
      document.getElementById('refreshBtn').addEventListener('click', async () => loadAll(document.getElementById('projectSelect').value));
      document.getElementById('btnAddProgress').addEventListener('click', async ()=> addProgress(document.getElementById('projectSelect').value));
      document.getElementById('btnAddLabor').addEventListener('click', async ()=> addLabor(document.getElementById('projectSelect').value));
      document.getElementById('btnAddEquip').addEventListener('click', async ()=> addEquip(document.getElementById('projectSelect').value));
      document.getElementById('btnAddMat').addEventListener('click', async ()=> addMat(document.getElementById('projectSelect').value));
      document.getElementById('btnAddSub').addEventListener('click', async ()=> addSub(document.getElementById('projectSelect').value));

      await loadAll(firstId || DEFAULT_PROJECT_ID);
    });
  </script>
</body>
</html>

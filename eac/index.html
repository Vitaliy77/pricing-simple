<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EAC Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-5 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">EAC Planner (Monthly)</h1>
      <div class="text-xs text-gray-500">Plan labor, subs, equipment & materials by month</div>
    </div>
  </header>

  <!-- Controls -->
  <main class="max-w-6xl mx-auto px-5 py-6 space-y-6">
    <section class="bg-white rounded-xl shadow-sm p-5 flex items-end gap-4">
      <div>
        <label class="block text-sm text-gray-600 mb-1">Month</label>
        <input id="monthPicker" type="month" class="border rounded-md p-2"
               value="2025-10"/>
      </div>
      <div class="grow"></div>
      <button id="refreshBtn" class="px-4 py-2 rounded-md bg-slate-600 text-white hover:bg-slate-700">
        Load / Refresh
      </button>
      <span id="status" class="text-sm text-slate-500"></span>
    </section>

    <!-- LABOR -->
    <section class="bg-white rounded-xl shadow-sm p-5 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Plan: Labor (by Employee)</h2>
        <button id="addLaborRow" class="px-3 py-1.5 rounded-md border hover:bg-slate-50">+ Add row</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-gray-600 border-b">
            <tr>
              <th class="py-2 pr-3">Employee</th>
              <th class="py-2 pr-3">Role</th>
              <th class="py-2 pr-3">Loaded Rate</th>
              <th class="py-2 pr-3">Override Rate</th>
              <th class="py-2 pr-3">Hours</th>
              <th class="py-2 pr-3">Cost (calc)</th>
              <th class="py-2 pr-3"></th>
            </tr>
          </thead>
          <tbody id="laborTbody"></tbody>
        </table>
      </div>
      <div class="flex items-center gap-3">
        <button id="saveLabor" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save Labor Plan</button>
        <span id="laborMsg" class="text-sm text-slate-500"></span>
      </div>
    </section>

    <!-- SUBS -->
    <section class="bg-white rounded-xl shadow-sm p-5 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Plan: Subcontractors</h2>
        <button id="addSubRow" class="px-3 py-1.5 rounded-md border hover:bg-slate-50">+ Add row</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-gray-600 border-b">
            <tr>
              <th class="py-2 pr-3">Vendor</th>
              <th class="py-2 pr-3">Cost</th>
              <th class="py-2 pr-3">Note</th>
              <th class="py-2 pr-3"></th>
            </tr>
          </thead>
          <tbody id="subsTbody"></tbody>
        </table>
      </div>
      <div class="flex items-center gap-3">
        <button id="saveSubs" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save Subs Plan</button>
        <span id="subsMsg" class="text-sm text-slate-500"></span>
      </div>
    </section>

    <!-- EQUIPMENT -->
    <section class="bg-white rounded-xl shadow-sm p-5 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Plan: Equipment</h2>
        <button id="addEquipRow" class="px-3 py-1.5 rounded-md border hover:bg-slate-50">+ Add row</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-gray-600 border-b">
            <tr>
              <th class="py-2 pr-3">Equipment</th>
              <th class="py-2 pr-3">Rate (unit)</th>
              <th class="py-2 pr-3">Hours</th>
              <th class="py-2 pr-3">Cost (calc)</th>
              <th class="py-2 pr-3"></th>
            </tr>
          </thead>
          <tbody id="equipTbody"></tbody>
        </table>
      </div>
      <div class="flex items-center gap-3">
        <button id="saveEquip" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save Equipment Plan</button>
        <span id="equipMsg" class="text-sm text-slate-500"></span>
      </div>
    </section>

    <!-- MATERIALS -->
    <section class="bg-white rounded-xl shadow-sm p-5 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Plan: Materials</h2>
        <button id="addMatRow" class="px-3 py-1.5 rounded-md border hover:bg-slate-50">+ Add row</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-gray-600 border-b">
            <tr>
              <th class="py-2 pr-3">SKU</th>
              <th class="py-2 pr-3">Unit Cost (incl waste)</th>
              <th class="py-2 pr-3">Qty</th>
              <th class="py-2 pr-3">Cost (calc)</th>
              <th class="py-2 pr-3"></th>
            </tr>
          </thead>
          <tbody id="matTbody"></tbody>
        </table>
      </div>
      <div class="flex items-center gap-3">
        <button id="saveMat" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Save Materials Plan</button>
        <span id="matMsg" class="text-sm text-slate-500"></span>
      </div>
    </section>
    <!-- MONTHLY P&L -->
    <section class="bg-white rounded-xl shadow-sm p-5 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Project P&L (Monthly)</h2>
        <button id="refreshPL" class="px-3 py-1.5 rounded-md border hover:bg-slate-50">Refresh P&L</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="plTable"></table>
      </div>
      <p class="text-xs text-slate-500">Revenue uses % complete (earned value) on baseline. Costs = Actuals (past) + Plan (future) + Indirects.</p>
    </section>

  </main>

  <script>
  // ====== CONFIG ======
  const SUPABASE_URL = 'https://yonpinjixytqooqyyzdh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvbnBpbmppeHl0cW9vcXl5emRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjkwMzIsImV4cCI6MjA3NDk0NTAzMn0.8g9iNl4kmIm77u7TT8cylgcV872D45pzZGHJWBnZBGo';
  const PROJECT_ID = 'bd5e7f00-ed56-4596-8414-62679107cae7';

  const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== CATALOG CACHES ======
  let rolesRate = {};           // role -> loaded_rate
  let employees = [];           // [{id, full_name, role}]
  let vendors = [];             // [{id, name}]
  let equipmentList = [];       // [{equip_type, rate, rate_unit}]
  let materialsList = [];       // [{sku, description, unit_cost, waste_pct}]

  // ====== HELPERS ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const monthToDate = (ym) => `${ym}-01`;

  function formatMoney(x){ return `$${(Number(x||0)).toFixed(2)}`; }

  // ====== LOAD LOOKUPS ======
  async function loadLookups(){
    // labor roles -> loaded rate
    const { data: lr, error: lrErr } = await client.from('labor_roles')
      .select('role, base_rate, burden_pct');
    if (lrErr) throw lrErr;
    rolesRate = {};
    lr.forEach(r => rolesRate[r.role] = +(r.base_rate * (1 + r.burden_pct)).toFixed(2));

    // employees
    const { data: emp, error: eErr } = await client
      .from('employees')
      .select('id, full_name, role')
      .eq('is_active', true);
    if (eErr) throw eErr;
    employees = emp || [];

    // subs
    const { data: subs, error: sErr } = await client
      .from('sub_vendors').select('id, name').order('name', {ascending:true});
    if (sErr) throw sErr;
    vendors = subs || [];

    // equipment
    const { data: eq, error: eqErr } = await client
      .from('equipment').select('equip_type, rate, rate_unit').order('equip_type');
    if (eqErr) throw eqErr;
    equipmentList = eq || [];

    // materials
    const { data: mat, error: mErr } = await client
      .from('materials').select('sku, description, unit_cost, waste_pct').order('sku');
    if (mErr) throw mErr;
    materialsList = mat || [];
  }

  // ====== ROW BUILDERS ======
  function makeLaborRow(row = {}){
    const tr = document.createElement('tr');
    tr.className = 'border-b last:border-0';

    const empSel = document.createElement('select');
    empSel.className = 'border rounded-md p-1.5 w-56';
    empSel.innerHTML = `<option value="">Select employee</option>` +
      employees.map(e => `<option value="${e.id}">${e.full_name}</option>`).join('');
    empSel.value = row.employee_id || '';
    empSel.onchange = () => {
      const e = employees.find(x => x.id === empSel.value);
      roleTd.textContent = e ? e.role : '';
      const r = e ? rolesRate[e.role] || 0 : 0;
      rateTd.textContent = formatMoney(r);
      recalcLaborRow();
    };

    const roleTd = document.createElement('td');
    roleTd.className = 'py-2 pr-3 text-slate-700';
    roleTd.textContent = (employees.find(e=>e.id===row.employee_id)?.role) || '';

    const rateTd = document.createElement('td');
    rateTd.className = 'py-2 pr-3';
    rateTd.textContent = formatMoney(rolesRate[roleTd.textContent] || 0);

    const overrideInput = document.createElement('input');
    overrideInput.type = 'number'; overrideInput.step = '0.01';
    overrideInput.className = 'border rounded-md p-1.5 w-28';
    overrideInput.value = row.override_rate ?? '';
    overrideInput.oninput = recalcLaborRow;

    const hoursInput = document.createElement('input');
    hoursInput.type = 'number'; hoursInput.step = '0.01';
    hoursInput.className = 'border rounded-md p-1.5 w-24';
    hoursInput.value = row.hours ?? '';
    hoursInput.oninput = recalcLaborRow;

    const costTd = document.createElement('td');
    costTd.className = 'py-2 pr-3 font-medium';
    costTd.textContent = '$0.00';

    const delBtn = document.createElement('button');
    delBtn.className = 'px-2 py-1 rounded-md border text-red-600 hover:bg-red-50';
    delBtn.textContent = 'Remove';
    delBtn.onclick = () => tr.remove();

    function recalcLaborRow(){
      const emp = employees.find(x => x.id === empSel.value);
      const role = emp ? emp.role : '';
      const baseRate = rolesRate[role] || 0;
      const rate = Number(overrideInput.value || baseRate);
      const hours = Number(hoursInput.value || 0);
      costTd.textContent = formatMoney(rate * hours);
    }

    tr.innerHTML = '';
    const tds = [
      tdWrap(empSel), roleTd, rateTd, tdWrap(overrideInput),
      tdWrap(hoursInput), costTd, tdWrap(delBtn)
    ];
    tds.forEach(td => tr.appendChild(td));

    // helper
    function tdWrap(el){ const td = document.createElement('td'); td.className='py-2 pr-3'; td.appendChild(el); return td; }

    // hydrate once
    empSel.dispatchEvent(new Event('change'));
    return tr;
  }

  function makeSubRow(row = {}){
    const tr = document.createElement('tr');
    tr.className = 'border-b last:border-0';

    const vendorSel = document.createElement('select');
    vendorSel.className = 'border rounded-md p-1.5 w-56';
    vendorSel.innerHTML = `<option value="">Select vendor</option>` +
      vendors.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
    vendorSel.value = row.vendor_id || '';

    const costInput = document.createElement('input');
    costInput.type = 'number'; costInput.step = '0.01';
    costInput.className = 'border rounded-md p-1.5 w-32';
    costInput.value = row.cost ?? '';

    const noteInput = document.createElement('input');
    noteInput.type = 'text'; noteInput.placeholder='(optional)';
    noteInput.className = 'border rounded-md p-1.5 w-64';
    noteInput.value = row.note ?? '';

    const delBtn = document.createElement('button');
    delBtn.className = 'px-2 py-1 rounded-md border text-red-600 hover:bg-red-50';
    delBtn.textContent = 'Remove';
    delBtn.onclick = () => tr.remove();

    [vendorSel, costInput, noteInput, delBtn].forEach((el, i) => {
      const td = document.createElement('td'); td.className = 'py-2 pr-3'; td.appendChild(el); tr.appendChild(td);
    });
    const tdEnd = document.createElement('td'); tdEnd.className='py-2 pr-3'; tr.appendChild(tdEnd);

    return tr;
  }

  function makeEquipRow(row = {}){
    const tr = document.createElement('tr');
    tr.className = 'border-b last:border-0';

    const equipSel = document.createElement('select');
    equipSel.className = 'border rounded-md p-1.5 w-56';
    equipSel.innerHTML = `<option value="">Select equipment</option>` +
      equipmentList.map(e => `<option value="${e.equip_type}">${e.equip_type}</option>`).join('');
    equipSel.value = row.equipment_type || '';

    const rateTd = document.createElement('td'); rateTd.className = 'py-2 pr-3'; rateTd.textContent = '';

    const hoursInput = document.createElement('input');
    hoursInput.type = 'number'; hoursInput.step = '0.01';
    hoursInput.className = 'border rounded-md p-1.5 w-24';
    hoursInput.value = row.hours ?? '';

    const costTd = document.createElement('td'); costTd.className = 'py-2 pr-3 font-medium'; costTd.textContent = '$0.00';

    const delBtn = document.createElement('button');
    delBtn.className = 'px-2 py-1 rounded-md border text-red-600 hover:bg-red-50';
    delBtn.textContent = 'Remove';
    delBtn.onclick = () => tr.remove();

    equipSel.onchange = recalc;
    hoursInput.oninput = recalc;

    function recalc(){
      const item = equipmentList.find(x => x.equip_type === equipSel.value);
      const rt = item ? item.rate : 0;
      const ru = item ? item.rate_unit : 'hour';
      rateTd.textContent = `${formatMoney(rt)} / ${ru}`;
      const hours = Number(hoursInput.value || 0);
      // If unit is 'day', treat input as days; else hours.
      const cost = hours * Number(rt || 0);
      costTd.textContent = formatMoney(cost);
    }

    tr.appendChild(tdWrap(equipSel));
    tr.appendChild(rateTd);
    tr.appendChild(tdWrap(hoursInput));
    tr.appendChild(costTd);
    tr.appendChild(tdWrap(delBtn));
    equipSel.dispatchEvent(new Event('change'));

    function tdWrap(el){ const td=document.createElement('td'); td.className='py-2 pr-3'; td.appendChild(el); return td; }
    return tr;
  }

  function makeMatRow(row = {}){
    const tr = document.createElement('tr');
    tr.className = 'border-b last:border-0';

    const skuSel = document.createElement('select');
    skuSel.className = 'border rounded-md p-1.5 w-64';
    skuSel.innerHTML = `<option value="">Select material</option>` +
      materialsList.map(m => `<option value="${m.sku}">${m.sku} — ${m.description}</option>`).join('');
    skuSel.value = row.sku || '';

    const unitTd = document.createElement('td'); unitTd.className = 'py-2 pr-3'; unitTd.textContent = '';

    const qtyInput = document.createElement('input');
    qtyInput.type = 'number'; qtyInput.step = '0.01';
    qtyInput.className = 'border rounded-md p-1.5 w-24';
    qtyInput.value = row.qty ?? '';

    const costTd = document.createElement('td'); costTd.className = 'py-2 pr-3 font-medium'; costTd.textContent = '$0.00';

    const delBtn = document.createElement('button');
    delBtn.className = 'px-2 py-1 rounded-md border text-red-600 hover:bg-red-50';
    delBtn.textContent = 'Remove';
    delBtn.onclick = () => tr.remove();

    skuSel.onchange = recalc;
    qtyInput.oninput = recalc;

    function recalc(){
      const item = materialsList.find(x => x.sku === skuSel.value);
      const unitCost = item ? (Number(item.unit_cost) * (1 + Number(item.waste_pct||0))) : 0;
      unitTd.textContent = `${formatMoney(unitCost)} (incl waste)`;
      const qty = Number(qtyInput.value || 0);
      costTd.textContent = formatMoney(unitCost * qty);
    }

    tr.appendChild(tdWrap(skuSel));
    tr.appendChild(unitTd);
    tr.appendChild(tdWrap(qtyInput));
    tr.appendChild(costTd);
    tr.appendChild(tdWrap(delBtn));
    skuSel.dispatchEvent(new Event('change'));

    function tdWrap(el){ const td=document.createElement('td'); td.className='py-2 pr-3'; td.appendChild(el); return td; }
    return tr;
  }

  // ====== ADD ROW BUTTONS ======
  $('#addLaborRow').onclick  = () => $('#laborTbody').appendChild(makeLaborRow());
  $('#addSubRow').onclick    = () => $('#subsTbody').appendChild(makeSubRow());
  $('#addEquipRow').onclick  = () => $('#equipTbody').appendChild(makeEquipRow());
  $('#addMatRow').onclick    = () => $('#matTbody').appendChild(makeMatRow());

  // ====== SAVE HANDLERS (UPSERT) ======
  async function saveLabor(){
    const ym = monthToDate($('#monthPicker').value);
    const rows = $$('#laborTbody tr');
    const payload = rows.map(tr => {
      const [empSel, , , overrideInput, hoursInput] = tr.querySelectorAll('select, input');
      const employee_id = empSel?.value || null;
      const hours = Number(hoursInput?.value || 0);
      const override_rate = overrideInput?.value ? Number(overrideInput.value) : null;
      if (!employee_id || hours <= 0) return null;
      return { project_id: PROJECT_ID, ym, employee_id, hours, override_rate };
    }).filter(Boolean);

    if (payload.length === 0) { $('#laborMsg').textContent = 'Nothing to save.'; return; }

    const { error } = await client.from('plan_labor').upsert(payload);
    $('#laborMsg').textContent = error ? `Error: ${error.message}` : `Saved ${payload.length} row(s).`;
  }

  async function saveSubs(){
    const ym = monthToDate($('#monthPicker').value);
    const rows = $$('#subsTbody tr');
    const payload = rows.map(tr => {
      const [vendorSel, costInput, noteInput] = tr.querySelectorAll('select, input');
      const vendor_id = vendorSel?.value || null;
      const cost = Number(costInput?.value || 0);
      const note = noteInput?.value || null;
      if (!vendor_id || cost <= 0) return null;
      return { project_id: PROJECT_ID, ym, vendor_id, cost, note };
    }).filter(Boolean);

    if (payload.length === 0) { $('#subsMsg').textContent = 'Nothing to save.'; return; }

    const { error } = await client.from('plan_subs').upsert(payload);
    $('#subsMsg').textContent = error ? `Error: ${error.message}` : `Saved ${payload.length} row(s).`;
  }

  async function saveEquip(){
    const ym = monthToDate($('#monthPicker').value);
    const rows = $$('#equipTbody tr');
    const payload = rows.map(tr => {
      const equip_type = tr.querySelector('select')?.value || null;
      const hours = Number(tr.querySelector('input')?.value || 0);
      if (!equip_type || hours <= 0) return null;
      return { project_id: PROJECT_ID, ym, equipment_type: equip_type, hours };
    }).filter(Boolean);

    if (payload.length === 0) { $('#equipMsg').textContent = 'Nothing to save.'; return; }

    const { error } = await client.from('plan_equipment').upsert(payload);
    $('#equipMsg').textContent = error ? `Error: ${error.message}` : `Saved ${payload.length} row(s).`;
  }

  async function saveMat(){
    const ym = monthToDate($('#monthPicker').value);
    const rows = $$('#matTbody tr');
    const payload = rows.map(tr => {
      const sku = tr.querySelector('select')?.value || null;
      const qty = Number(tr.querySelector('input')?.value || 0);
      if (!sku || qty <= 0) return null;
      return { project_id: PROJECT_ID, ym, sku, qty };
    }).filter(Boolean);

    if (payload.length === 0) { $('#matMsg').textContent = 'Nothing to save.'; return; }

    const { error } = await client.from('plan_materials').upsert(payload);
    $('#matMsg').textContent = error ? `Error: ${error.message}` : `Saved ${payload.length} row(s).`;
  }

  $('#saveLabor').onclick = saveLabor;
  $('#saveSubs').onclick  = saveSubs;
  $('#saveEquip').onclick = saveEquip;
  $('#saveMat').onclick   = saveMat;

  // ====== LOAD EXISTING PLAN FOR MONTH (optional convenience) ======
  async function loadExistingPlanForMonth(){
    const ym = monthToDate($('#monthPicker').value);
    $('#laborTbody').innerHTML = '';
    $('#subsTbody').innerHTML  = '';
    $('#equipTbody').innerHTML = '';
    $('#matTbody').innerHTML   = '';

    // Labor
    const { data: pl, error: plErr } = await client
      .from('plan_labor')
      .select('employee_id, hours, override_rate')
      .eq('project_id', PROJECT_ID).eq('ym', ym);
    if (!plErr && pl) pl.forEach(r => $('#laborTbody').appendChild(makeLaborRow(r)));

    // Subs
    const { data: ps, error: psErr } = await client
      .from('plan_subs')
      .select('vendor_id, cost, note')
      .eq('project_id', PROJECT_ID).eq('ym', ym);
    if (!psErr && ps) ps.forEach(r => $('#subsTbody').appendChild(makeSubRow(r)));

    // Equipment
    const { data: pe, error: peErr } = await client
      .from('plan_equipment')
      .select('equipment_type, hours')
      .eq('project_id', PROJECT_ID).eq('ym', ym);
    if (!peErr && pe) pe.forEach(r => $('#equipTbody').appendChild(makeEquipRow(r)));

    // Materials
    const { data: pm, error: pmErr } = await client
      .from('plan_materials')
      .select('sku, qty')
      .eq('project_id', PROJECT_ID).eq('ym', ym);
    if (!pmErr && pm) pm.forEach(r => $('#matTbody').appendChild(makeMatRow(r)));
  }

  // ====== INIT ======
  async function init(){
    try{
      $('#status').textContent = 'Loading catalogs…';
      await loadLookups();
      $('#status').textContent = 'Catalogs loaded.';
      await loadExistingPlanForMonth();
    }catch(err){
      console.error(err);
      $('#status').textContent = 'Error loading data: ' + (err.message||err);
    }
  }

  $('#refreshBtn').onclick = init;
  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
